---
title: "Most Searched Players"
output:
  html_document: 
    includes:
      in_header: analytics.html
  pdf_document: default
  word_document: default
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=10, fig.height=6, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)

# Show a maximum of 100   
options(tibble.print_max = 100, tibble.print_min = 5)

library(tidyverse)
library(DBI)

con <- DBI::dbConnect(odbc::odbc(), 
                      Driver = "SQL Server", 
                      Server = "DESKTOP-S1K43CL\\SQLEXPRESS", 
                      Database = "Fortnite", 
                      Trusted_Connection = "True")


player_count_tbl <- dbGetQuery(con, paste0("SELECT COUNT (DISTINCT Name) FROM PlayerSearchView ")) 
player_count <- prettyNum(player_count_tbl[1, 1], big.mark=",")

search_count_tbl <- dbGetQuery(con, paste0("SELECT SUM(UniqueEvents) FROM PlayerSearchView")) 
search_count <- prettyNum(search_count_tbl[1, 1], big.mark=",")


## UPDATE THESE
min_searches <- 25
update_date <- "November 23, 2019"


#raw_data <- read_csv("C:/project/fortnite/r/player-search/data2.csv")
raw_data <- dbGetQuery(con, paste0("SELECT * FROM PlayerSearchView"))

```
Back to [Fortnite Ping](<https://www.fortniteping.com>) 

***Last updated `r update_date`***

We started tracking player searches on Fortnite Ping in mid October 2019. `r player_count` players have been searched in more than `r search_count` searches. Here is the breakdown of searches by region. The relatively large number of searches in NA East may be due to the it being used to organize scrims.

```{r region_search_chart, fig.width = 7, fig.height = 2}

regions <- raw_data %>% 
  group_by(Region) %>% 
  summarize(total = sum(TotalEvents))
  
ggplot(regions, aes(x = total, y = reorder(Region, total))) +
  geom_segment(aes(yend = Region), xend = 0, color = "grey50", size = 2) +
  geom_point(size = 4, color = "black") +
  scale_color_brewer(palette = "Set1") +
  theme_bw() + 
  theme(legend.position = "none") + 
  theme(panel.grid.major.y = element_blank()) +
  labs(
    x = "",
    y = ""
  ) 
```

Here is a breakdown of the players who have more than `r min_searches` searches. Note that we don't track who was doing the searching, only who was searched.

```{r player_search_chart, fig.width = 8, fig.height = 26}

searches <- raw_data %>% 
  group_by(Name, Region) %>% 
  summarize(total = sum(TotalEvents)) %>%
  group_by(Region) %>%
  filter(total > min_searches)
  #top_n(2)  -- top n in region
  
ggplot(searches, aes(x = total, y = reorder(Name, total))) +
  geom_segment(aes(yend = Name), xend = 0, color = "grey50", size = 2) +
  geom_point(size = 4, aes(color = Region)) +
  scale_color_brewer(palette = "Set1") +
  theme_bw() + 
  theme(legend.position = "top") + 
  theme(panel.grid.major.y = element_blank()) +
  labs(x = "", y = "") +
  facet_grid(Region ~ ., scales = "free_y", space = "free_y")



```

**Player searches by region and day**

```{r player_search_by_day_chart, fig.width = 9, fig.height = 4}

days <- raw_data  

ggplot(days, aes(x = SearchDate, y = TotalEvents, fill = Region)) +
  geom_col() +
  labs(y = "Player Searches", x = "") + 
  theme(axis.text.x = element_text(angle = 40, hjust = 1))

```

